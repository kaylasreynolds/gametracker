<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Game Tracker - Home</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Poppins:wght@500;600&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div id="root"></div>

    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="text/babel">
      const { useState } = React;

      const PRESET_COLORS = [
        "#d55a6d", "#e2c94c", "#6a4e8d", "#a3c1a0", 
        "#d77b4a", "#4e8e9d", "#7a9bc2", "#4b545e"
      ];

      const Button = ({ children, disabled, onClick }) => (
        <button className="button" disabled={disabled} onClick={onClick} type="button">
          {children}
        </button>
      );

      const Switch = ({ checked, onToggle, label }) => (
        <button
          className="switch"
          type="button"
          role="switch"
          aria-checked={checked}
          aria-label={label}
          data-active={checked}
          onClick={onToggle}
        >
          <span className="switch-knob" aria-hidden="true"></span>
        </button>
      );

      const Card = ({ children, className = "" }) => (
        <div className={`card ${className}`.trim()}>{children}</div>
      );

      const HomePage = () => {
        const STORAGE_KEY = "gameTracker.previousGames";

        const [previousGames, setPreviousGames] = useState(() => {
          try {
            const raw = localStorage.getItem(STORAGE_KEY);
            return raw ? JSON.parse(raw) : [];
          } catch {
            return [];
          }
        });

        const [gameName, setGameName] = useState("");
        const [highestWins, setHighestWins] = useState(true);
        const [menuOpen, setMenuOpen] = useState(false);
        const [darkMode, setDarkMode] = useState(false);
        const [currentGame, setCurrentGame] = useState("");
        const [round, setRound] = useState(1);
        const [sortMode, setSortMode] = useState("custom");
        const [players, setPlayers] = useState([]);
        const [mode, setMode] = useState("game");
        const [viewOnly, setViewOnly] = useState(false);
        const [addMode, setAddMode] = useState("saved");
        const [editingPlayerId, setEditingPlayerId] = useState(null);
        const [pointsPlayerId, setPointsPlayerId] = useState(null);
        const [pointsValue, setPointsValue] = useState("");
        const [endSnapshot, setEndSnapshot] = useState(null);
        const [playersWhoScoredThisRound, setPlayersWhoScoredThisRound] = useState(new Set());


        const [savedPlayers] = useState([
          { id: "s1", name: "Kayla", color: "#d55a6d" },
          { id: "s2", name: "MiKayla", color: "#6a4e8d" },
          { id: "s3", name: "Tyrell", color: "#a3c1a0" },
          { id: "s4", name: "Brandon", color: "#d77b4a" },
        ]);

        const [selectedSavedId, setSelectedSavedId] = useState(savedPlayers[0]?.id ?? "");
        const [newPlayerName, setNewPlayerName] = useState("");
        const [newPlayerColor, setNewPlayerColor] = useState("#a78bfa");

        React.useEffect(() => {
          try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(previousGames));
          } catch {
            // ignore
          }
        }, [previousGames]);

        React.useEffect(() => {
          document.body.classList.toggle("dark", darkMode);
        }, [darkMode]);

        const toInitials = (name) =>
          (name || "P")
            .trim()
            .split(/\s+/)
            .slice(0, 2)
            .map((s) => s[0]?.toUpperCase() ?? "")
            .join("");

        const computeWinnerIds = (playerList, highestWinsFlag) => {
          const eligible = (playerList || []).filter((p) => Number.isFinite(p.score));
          if (eligible.length === 0) return [];
          const scores = eligible.map((p) => p.score);
          const target = highestWinsFlag ? Math.max(...scores) : Math.min(...scores);
          return eligible.filter((p) => p.score === target).map((p) => p.id);
        };

        const goHome = () => {
          setCurrentGame("");
          setMode("game");
          setViewOnly(false);
          setPlayers([]);
          setRound(1);
          setSortMode("custom");
          setPointsPlayerId(null);
          setPointsValue("");
          setEditingPlayerId(null);
          setAddMode("saved");
          setPlayersWhoScoredThisRound(new Set());
        };

        const openPoints = (playerId) => {
          setPointsPlayerId(playerId);
          setPointsValue("");
          setMode("points");
        };

        const appendDigit = (digit) => {
          setPointsValue((prev) => {
            const raw = prev || "";
            const sign = raw.startsWith("-") ? "-" : "";
            const core = sign ? raw.slice(1) : raw;

            const nextCore = core === "0" ? String(digit) : core + String(digit);
            return sign + nextCore;
          });
        };

        const toggleMinus = () => {
          setPointsValue((prev) => {
            if (!prev) return "-";
            return prev.startsWith("-") ? prev.slice(1) : "-" + prev;
          });
        };

        const backspacePoints = () => {
          setPointsValue((prev) => {
            if (!prev) return "";
            const next = prev.slice(0, -1);
            return next === "-" ? "" : next;
          });
        };

        const commitPoints = () => {
          const parsed = parseInt(pointsValue || "0", 10);
          if (!Number.isFinite(parsed) || parsed === 0) {
            setMode("game");
            setPointsPlayerId(null);
            setPointsValue("");
            return;
          }

          setPlayers((prev) =>
            prev.map((p) => (p.id === pointsPlayerId ? { ...p, score: (p.score ?? 0) + parsed } : p))
          );
          
          // Track that this player has scored this round
          if (!viewOnly) {
            setPlayersWhoScoredThisRound((prevSet) => {
              const newSet = new Set(prevSet);
              newSet.add(pointsPlayerId);
              
              // Check if all players have now scored
              if (newSet.size === players.length) {
                setRound((r) => r + 1);
                return new Set(); // Reset for next round
              }
              
              return newSet;
            });
          }
          
          setMode("game");
          setPointsPlayerId(null);
          setPointsValue("");
        };

        const handleStart = () => {
          const name = gameName.trim();
          if (!name) return;

          setRound(1);
          setSortMode("custom");
          setPlayers([]);
          setMode("game");
          setViewOnly(false);
          setCurrentGame(name);
          setPlayersWhoScoredThisRound(new Set());
        };

        const endGame = () => {
          if (!players.length) return;

          const winnerIds = computeWinnerIds(players, highestWins);

          setEndSnapshot({
            name: currentGame,
            highestWins,
            round,
            playersData: players,
            winnerIds,
          });

          setMode("end");
        };

        const finalizeEndGame = () => {
          if (!endSnapshot) return;

          const playerCount = endSnapshot.playersData.length;
          const summary = `${playerCount} Player${playerCount === 1 ? "" : "s"}`;

          const ended = {
            id: Date.now(),
            name: endSnapshot.name,
            players: summary,
            endedAt: new Date().toISOString(),
            highestWins: endSnapshot.highestWins,
            round: endSnapshot.round,
            playersData: endSnapshot.playersData,
            winnerIds: endSnapshot.winnerIds,
          };

          setPreviousGames((prev) => [ended, ...prev]);
          setEndSnapshot(null);
          setGameName("");
          goHome();
        };

        const viewPreviousGame = (id) => {
          const found = previousGames.find((g) => g.id === id);
          if (!found) return;
          const snapshot = Array.isArray(found.playersData) ? found.playersData : [];
          setPlayers(snapshot);
          setRound(typeof found.round === "number" ? found.round : 1);
          setSortMode("custom");
          setMode("game");
          setViewOnly(true);
          setHighestWins(typeof found.highestWins === "boolean" ? found.highestWins : true);
          setCurrentGame(found.name || "Game");
          setPlayersWhoScoredThisRound(new Set());
        };

        const deletePreviousGame = (id) => {
          const confirmed = window.confirm("Delete this game? This cannot be undone.");
          if (!confirmed) return;
          setPreviousGames((prev) => prev.filter((g) => g.id !== id));
        };

        const addPlayerToGame = (player) => {
          setPlayers((prev) => {
            const nextOrder = prev.length ? Math.max(...prev.map((p) => p.order)) + 1 : 1;
            const nextId = prev.length ? Math.max(...prev.map((p) => p.id)) + 1 : 1;
            return [...prev, { id: nextId, name: player.name, color: player.color, score: 0, order: nextOrder }];
          });
        };

        const handleDoneAddPlayer = () => {
          if (addMode === "saved") {
            const chosen = savedPlayers.find((p) => p.id === selectedSavedId);
            if (chosen) addPlayerToGame(chosen);
            setMode("game");
            return;
          }

          const trimmed = newPlayerName.trim();
          if (!trimmed) return;

          if (editingPlayerId != null) {
            setPlayers((prev) =>
              prev.map((p) =>
                p.id === editingPlayerId
                  ? { ...p, name: trimmed, color: newPlayerColor }
                  : p
              )
            );
            setEditingPlayerId(null);
          } else {
            addPlayerToGame({ name: trimmed, color: newPlayerColor });
          }

          setNewPlayerName("");
          setNewPlayerColor("#a78bfa");
          setMode("game");
        };

        const deletePlayerFromGame = (id) => {
          setPlayers((prev) => prev.filter((p) => p.id !== id));
        };

        if (currentGame) {
          const sortedPlayers = [...players].sort((a, b) => {
            if (sortMode === "high") return b.score - a.score;
            if (sortMode === "low") return a.score - b.score;
            return 0;
          });

          const winnerIds = viewOnly ? computeWinnerIds(players, highestWins) : [];

          if (mode === "points") {
            const target = players.find((p) => p.id === pointsPlayerId);
            return (
              <div className="page game-screen">
                <div className="game-header">
                  <button
                    className="icon-button"
                    type="button"
                    onClick={() => {
                      setMode("game");
                      setPointsPlayerId(null);
                      setPointsValue("");
                    }}
                    aria-label="Back"
                  >
                    ‚Üê
                  </button>
                  <h1>Points</h1>
                  <button className="ghost-button" type="button" onClick={commitPoints}>
                    Done
                  </button>
                </div>

                <div className="points-shell">
                  <div className="points-label">
                    {target ? `${target.name} ‚Ä¢ Current: ${target.score ?? 0}` : "Enter points"}
                  </div>
                  <div className="points-display" aria-label="Points entry">
                    {pointsValue || "0"}
                  </div>

                  <div className="keygrid" role="group" aria-label="Number pad">
                    {[1, 2, 3, 4, 5, 6, 7, 8, 9].map((n) => (
                      <button
                        key={n}
                        type="button"
                        className="key"
                        onClick={() => appendDigit(n)}
                        aria-label={`Enter ${n}`}
                      >
                        {n}
                      </button>
                    ))}

                    <button
                      type="button"
                      className="key accent secondary"
                      onClick={toggleMinus}
                      aria-label="Toggle negative"
                    >
                      ‚àí
                    </button>

                    <button type="button" className="key" onClick={() => appendDigit(0)} aria-label="Enter 0">
                      0
                    </button>

                    <button
                      type="button"
                      className="key accent secondary"
                      onClick={backspacePoints}
                      aria-label="Backspace"
                    >
                      ‚å´
                    </button>
                  </div>
                </div>
              </div>
            );
          }

          
          if (mode === "end") {
            const snap = endSnapshot;
            const list = snap?.playersData ?? [];
            const winnerIds = new Set(snap?.winnerIds ?? []);

            const title = winnerIds.size > 1 ? "Winners!!" : "Winner!!";

            return (
              <div className="page game-screen end-screen">
                <div className="game-header">
                  <button
                    className="icon-button"
                    type="button"
                    onClick={() => {
                      setMode("game");
                      setEndSnapshot(null);
                    }}
                    aria-label="Back"
                  >
                    ‚Üê
                  </button>
                  <h1>{winnerIds.size ? title : "Select the Winner!"}</h1>
                  <button className="ghost-button" type="button" onClick={finalizeEndGame}>
                    Done
                  </button>
                </div>

                <div className="end-body">
                  <div className="end-grid">
                    {list.map((p) => {
                      const isWinner = winnerIds.has(p.id);
                      return (
                        <button
                          key={p.id}
                          type="button"
                          className={"end-circle" + (isWinner ? " winner" : "")}
                          style={{
                            borderColor: p.color,
                            background: isWinner ? p.color : "transparent",
                          }}
                          onClick={() => {
                            // Allow manual override of the winner selection
                            setEndSnapshot((prev) => {
                              if (!prev) return prev;
                              return { ...prev, winnerIds: [p.id] };
                            });
                          }}
                          aria-label={`Select ${p.name} as winner`}
                        >
                          <div className="end-circle-inner">
                            <div className={"end-name" + (isWinner ? " winner" : "")}>{p.name}</div>
                            <div className={"end-color" + (isWinner ? " winner" : "")}>
                              {p.score ?? 0}
                            </div>
                          </div>
                        </button>
                      );
                    })}
                  </div>
                </div>
              </div>
            );
          }

if (mode === "addPlayer") {
            return (
              <div className="page game-screen">
                <div className="game-header">
                  <button className="icon-button" type="button" onClick={() => setMode("game")}>
                    ‚Üê
                  </button>
                  <h1>Add Player</h1>
                  <button className="ghost-button" type="button" onClick={() => setMode("game")}>
                    Cancel
                  </button>
                </div>

                <div className="segmented">
                  <button
                    type="button"
                    data-active={addMode === "saved"}
                    onClick={() => setAddMode("saved")}
                  >
                    Select from Saved Players
                  </button>
                  <button
                    type="button"
                    data-active={addMode === "new"}
                    onClick={() => setAddMode("new")}
                  >
                    Create a New Player
                  </button>
                </div>

                <div className="card">
                  {addMode === "saved" ? (
                    <div className="form-grid">
                      <div className="field-row">
                        <label htmlFor="savedPlayer">Saved Players</label>
                        <select
                          id="savedPlayer"
                          className="saved-select"
                          value={selectedSavedId}
                          onChange={(e) => setSelectedSavedId(e.target.value)}
                        >
                          {savedPlayers.map((p) => (
                            <option value={p.id} key={p.id}>
                              {p.name}
                            </option>
                          ))}
                        </select>
                        <p className="small-muted">Pick a saved player and press Done to add them to this game.</p>
                      </div>
                    </div>
                  ) : (
                    <div className="form-grid">
                      <div className="field-row">
                        <label htmlFor="playerName">Name</label>
                        <input
                          id="playerName"
                          type="text"
                          placeholder="e.g., Player 3"
                          value={newPlayerName}
                          onChange={(e) => setNewPlayerName(e.target.value)}
                        />
                      </div>

                      <div className="field-row">
                        <label>Color</label>
                        <div className="color-grid">
                          {PRESET_COLORS.map((color) => (
                            <button
                              key={color}
                              type="button"
                              className="color-option"
                              style={{ background: color }}
                              data-selected={newPlayerColor === color}
                              onClick={() => setNewPlayerColor(color)}
                              aria-label={`Select color ${color}`}
                            />
                          ))}
                        </div>
                      </div>
                    </div>
                  )}

                  <Button
                    onClick={handleDoneAddPlayer}
                    disabled={addMode === "new" ? !newPlayerName.trim() : !selectedSavedId}
                  >
                    Done
                  </Button>

                  <div className="divider" />

                  <div className="small-muted" style={{ fontWeight: 700, color: "var(--text)" }}>
                    Current players in the game
                  </div>

                  <div style={{ display: "flex", flexDirection: "column", gap: 10 }}>
                    {players.map((p, idx) => (
                      <div key={p.id} style={{ display: "flex", alignItems: "center", justifyContent: "space-between", gap: 14, padding: "12px", borderRadius: 16, border: "1px solid rgba(122, 122, 122, 0.18)" }}>
                        <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
                          <div
                            className="player-chip"
                            style={{ background: p.color }}
                            aria-hidden="true"
                          ></div>
                          <div className="player-name">{p.name}</div>
                        </div>

                        <div className="row-actions">
                          <span className="score-right">Player {idx + 1}</span>

                          <button className="pill-button danger" type="button" onClick={() => deletePlayerFromGame(p.id)}>
                            Delete
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            );
          }

          return (
            <div className="page game-screen">
              <div className="game-header">
                <div style={{ display: "flex", gap: 10, alignItems: "center" }}>
                  <button className="icon-button" type="button" onClick={goHome} aria-label="Back">
                    ‚Üê
                  </button>

                  <button
                    className="icon-button small"
                    type="button"
                    onClick={() => setMode("addPlayer")}
                    aria-label="Add player"
                    disabled={viewOnly}
                  >
                    +
                  </button>
                </div>

                <h1>{currentGame}</h1>

                {viewOnly ? (
                  <button className="ghost-button" type="button" onClick={goHome}>
                    Back
                  </button>
                ) : (
                  <button className="ghost-button" type="button" onClick={endGame}>
                    End Game
                  </button>
                )}
              </div>

              <div className="subheader-row">
                <div className="round-controls">
                  <div className="round-pill">
                    <span>Round:</span>
                    <span>{round}</span>
                  </div>
                  <div className="round-stepper">
                    <button
                      className="stepper-btn"
                      type="button"
                      onClick={() => {
                        setRound((r) => Math.max(1, r - 1));
                        setPlayersWhoScoredThisRound(new Set());
                      }}
                      aria-label="Previous round"
                    >
                      ‚àí
                    </button>
                    <button
                      className="stepper-btn"
                      type="button"
                      onClick={() => {
                        setRound((r) => r + 1);
                        setPlayersWhoScoredThisRound(new Set());
                      }}
                      aria-label="Next round"
                    >
                      +
                    </button>
                  </div>
                </div>

                <div className="sort-control">
                  <span>Sort by</span>
                  <select
                    className="select"
                    value={sortMode}
                    onChange={(e) => setSortMode(e.target.value)}
                    aria-label="Sort players"
                  >
                    <option value="high">Highest points</option>
                    <option value="low">Lowest points</option>
                  </select>
                </div>
              </div>

              <div className="players-card">
                {sortedPlayers.map((p) => (
                  <div
                    className={`player-row ${winnerIds.includes(p.id) ? "winner" : ""}`.trim()}
                    key={p.id}
                  >
                    <div className="player-left">
                      <div className="player-chip" style={{ background: p.color }} aria-hidden="true"></div>
                      <div className="player-name">{p.name}</div>
                    </div>

                    <div style={{ display: "flex", alignItems: "center", gap: 14 }}>
                      {winnerIds.includes(p.id) && <span className="winner-badge">Winner</span>}
                      <div className="score-right">Score: {p.score}</div>

                      <button
                        className="pill-button"
                        type="button"
                        onClick={() => openPoints(p.id)}
                        disabled={viewOnly}
                      >
                        Points
                      </button>
                    </div>
                  </div>
                ))}
              </div>

              
            </div>
          );
        }

        return (
          <div className="page">
            <div className="menu">
              <button
                className="menu-button"
                type="button"
                aria-haspopup="true"
                aria-expanded={menuOpen}
                aria-controls="menu-panel"
                onClick={() => setMenuOpen((value) => !value)}
              >
                <span className="menu-icon" aria-hidden="true">
                  <span></span>
                  <span></span>
                  <span></span>
                </span>
                <span className="sr-only">Open menu</span>
              </button>
              {menuOpen && (
                <div className="menu-panel" id="menu-panel" role="menu">
                  <div className="menu-row" role="none">
                    <span>Dark mode</span>
                    <Switch
                      checked={darkMode}
                      onToggle={() => setDarkMode((value) => !value)}
                      label="Toggle dark mode"
                    />
                  </div>
                  <button className="menu-item" type="button" role="menuitem">
                    Reset
                  </button>
                </div>
              )}
            </div>
            <header>
              <h1>Games</h1>
              <p>Track your board &amp; card games</p>
            </header>

            <Card>
              <h2 className="card-title">Start a New Game!</h2>
              <div className="input">
                <label htmlFor="gameName">Game Name</label>
                <input
                  id="gameName"
                  type="text"
                  placeholder="e.g., Catan Night"
                  value={gameName}
                  onChange={(event) => setGameName(event.target.value)}
                />
              </div>
              <div className="toggle-row">
                <span>Highest score wins üèÜ</span>
                <Switch
                  checked={highestWins}
                  onToggle={() => setHighestWins((value) => !value)}
                  label="Highest score wins"
                />
              </div>
              <Button disabled={!gameName.trim()} onClick={handleStart}>
                Start New Game
              </Button>
            </Card>

            <section>
              <div className="section-header">
                <h2>Previous Games</h2>
              </div>

              {previousGames.length === 0 ? (
                <div className="card">
                  <p style={{ color: "var(--muted)", textAlign: "center" }}>
                    No games yet. Start one above!
                  </p>
                </div>
              ) : (
                <div className="game-list">
                  {previousGames.map((game) => (
                    <a href="#" className="game-card" key={game.id}>
                      <div className="game-card-top">
                        <h3>{game.name}</h3>
                        <span>{game.players}</span>
                      </div>
                      <div className="game-card-actions">
                      
                        <button
                          className="pill-button"
                          type="button"
                          onClick={(e) => {
                            e.preventDefault();
                            viewPreviousGame(game.id);
                          }}
                        >
                          View
                        </button>

                        <button
                          className="pill-button"
                          type="button"
                          onClick={(e) => {
                            e.preventDefault();
                            deletePreviousGame(game.id);
                          }}
                          aria-label={`Delete ${game.name}`}
                        >
                          Delete
                        </button>
                      </div>
                    </a>
                  ))}
                </div>
              )}
            </section>
          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<HomePage />);
    </script>
  </body>
</html>
